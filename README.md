# Дипломная работа по профессии «Системный администратор» - Андрей Сотников

## Список использованного ПО

| SW | Версия |
| --- | --- |
| Ansible | 2.15.1 |
| Terraform | 1.5.1 |
| Fedora | 37 |

## План развертывания

0. Получение аутентификационного токена Yandex.Cloud для управления облачными ресурсами через Terraform.
1. Создание [ресурсов]( ##Используемые ресурсы Yandex.Cloud) при помощи Terraform.
2. В ходе развертывания инфрастурктуры на Bastion сервер устанавливаются Git и Ansible, передается файл конфигурации ansible.cfg, затем производится загрузка ролей Ansible из VCS (GitHub).
3. Подключение по SSH к Bastion серверу и запуск плейбуков Ansible производится вручную, через SSH соединение, но можно настроить и автоматическое развертывание при помощи CI/CD-инструментов (например, Jenkins).
4. Запуск плейбука Ansible для развертывания и конфигурации сервисов при помощи ролей.

## Используемые ресурсы Yandex.Cloud

### Виртуальные машины

Инфраструктура разворачивается на семи виртуальных машинах. В качестве ОС используется Fedora 37.  
Настроено автоматическое создание снэпшотов для всех дисков, с ежедневным копированием.  

Список ВМ с затребованными ресурсами представлен в сводной таблице.

### Сеть и сетевое взаимодействие

В проекте используется две приватных подсети без доступа в интернет (в разных сетевых зонах) и одна публичная подсеть. Доступ во вне есть со всех машин, осуществляется через NAT-шлюз, трафик в который заворачивается при помощи таблицы маршрутизации. Доступ к машинам ограничен с помощью security groups - открыты только нужные порты.  
Дополнительно каждой машине присвоена DNS-запись для облегчения взаимодействия внутри сети.

#### L7 Балансировщик нагрузки

Для маршрутизации входящего трафика к веб-серверам используется L7-балансировщик (Application Load Balancer), который состоит из целевой группы, в которую помещаются веб-серверы, бэкенд-группы, которая определяет настройки балансировки, роутера, который определяет правила маршрутизации запросов в группу бэкенда и балансировщика, который принимает трафик и передает его собственно на эндпоинты бэкендов согласно настройкам обработчиков.

| Наименование | ППО | CPU | RAM | Внутренний FQDN | Подсеть |
| --- | --- | --- | --- | --- | --- |
| webserver-1 | Nginx | 2 | 2G | web1.dip.lom | private-subnet-a |
| webserver-2 | Nginx | 2 | 2G | web2.dip.lom | private-subnet-b |
| prometheus | prometheus | 2 | 4G | prometheus.dip.lom | private-subnet-b |
| grafana | grafana | 2 | 2G | grafana.dip.lom | public-subnet |
| elaticsearch | elaticsearch (in Docker) | 2 | 4G | es.dip.lom | private-subnet-a |
| kibana | kibana (in Docker) | 2 | 4G | kibana.dip.lom | public-subnet |
| bastion-host | - | 2 | 1G | bastion.dip.lom | public-subnet |

## Развертывание сервисов

Развертывание сервисов осуществляется при помощи Ansible. Так как этот шаг производится после развертывания инфраструктуры, в том числе, после применения правил групп безопасности, Ansible-контроллер размещен на Bastion-сервере, с которого имеется доступ по SSH на все остальные машины.

Во время разворачивания Bastion на него устанавливаются пакеты git и ansible, затем выполняется git clone репозитория с плейбуком и ролями Ansible.

### Репозиторий Ansible

Состав репозитория:

* ansible.cfg - конфигурационный файл ansible.
* ansible.key - приватный ключ для доступа к ВМ по SSH. Чтобы не хранить ключ в открытом виде, он зашифрован при помощи утилиты ansible vault. Расшифровка происходит первым шагом при запуске плейбука. Для расшифровки требуется пароль.

1. webservers - установка Nginx и статики, обновление статики
1. metrics - установка и конфигурация экспортеров (NodeExporter, NgninxlogExporter)
1. grafana - установка и конфигурация grafana
1. prometheus - установка и конфигурация Prometheus
1. docker - установка docker на виртуальные машины для ElasticSearch и Kibana
1. elasticsearch - установка и конфигурация Elasticsearch
1. kibana - установка и конфигурация Kibana
1. filebeat/fluent-bit - установка сборщика логов.
