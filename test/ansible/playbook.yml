- name: Setup nginx
  hosts: all
  gather_facts: false
  become: true

  tasks:
    - name: Update yum and install nginx
      ansible.builtin.dnf:
        update_cache: true
        name: nginx
        state: present

    - name: Open HTTP port
      ansible.posix.firewalld:
        service: http
        state: enabled
        permanent: true

    - name: Update static
      ansible.builtin.copy:
        src: '../../site/static/'
        dest: '/usr/share/nginx/html/'
        owner: nginx
        mode: '600'
      notify: Restart nginx

    - name: Start and enable nginx
      ansible.builtin.systemd:
        service: nginx
        state: started
        enabled: true

  handlers:
    - name: Restart nginx
      ansible.builtin.systemd:
        service: nginx
        state: restarted

- name: Setup exporters
  hosts: all
  gather_facts: false
  become: true

  tasks:

    - name: Add group
      ansible.builtin.group:
        name: "exporter"
        state: present
        system: true

    - name: Add user
      ansible.builtin.user:
        name: "exporter"
        group: "exporter"
        create_home: false
        system: true
        state: present

    - name: Download node_exporter
      ansible.builtin.unarchive:
        remote_src: true
        src: {{ node_exporter_url }}
        dest: '/tmp/'
